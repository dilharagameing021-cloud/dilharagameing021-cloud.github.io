<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator and Scanner</title>
        <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 'Inter' font is used here */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Additional features for animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        .scale-in {
            animation: scaleIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        /* Styles for the camera video feed */
        #video-feed {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
        <div class="absolute top-4 right-4">
        <button id="lang-toggle" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg shadow-md hover:bg-gray-300 transition-colors duration-200">
            English
        </button>
    </div>

        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-sm w-full mx-4 text-center">

                <div id="auth-container" class="fade-in">
            <h1 id="auth-title" class="text-4xl font-extrabold text-gray-800 mb-6">QR කේත ඇප් එක</h1>
            <p id="auth-message" class="text-gray-600 mb-6">කරුණාකර ඔබගේ නම ඇතුළත් කරන්න.</p>

                        <div id="login-form">
                <input type="text" id="user-name" placeholder="ඔබගේ නම" class="w-full p-4 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:border-transparent transition-all duration-300">
                <button id="login-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-4 rounded-lg transition-colors transform hover:scale-105 duration-300 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 shadow-md">ඉදිරියට යන්න</button>
            </div>
        </div>

                <div id="qr-code-container" class="hidden">
            <p id="user-info" class="text-sm text-gray-500 mb-4"></p>

                        <div class="flex justify-center space-x-4 mb-6">
                <button id="mode-generator" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 shadow-md">සාදන්නා</button>
                <button id="mode-scanner" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg transition-colors duration-200 shadow-md">ස්කෑනරය</button>
            </div>

                        <div id="generator-section">
                <h1 class="text-4xl font-extrabold text-gray-800 mb-6" id="qr-title">QR කේත සාදන්න</h1>
                
                                <div class="flex justify-center space-x-4 mb-6">
                    <button id="gen-mode-url" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 shadow-md">වෙබ් ලිපිනය</button>
                    <button id="gen-mode-phone" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg transition-colors duration-200 shadow-md">දුරකථන අංකය</button>
                </div>

                                <div id="url-generator-section">
                    <p id="message-generate-url" class="text-gray-600 mb-6">කරුණාකර URL එකක් ඇතුළත් කරන්න.</p>
                    <input type="url" id="url-input" placeholder="වෙබ් ලිපිනයක් මෙහි ඇතුළත් කරන්න" class="w-full p-4 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:border-transparent transition-all duration-300">
                </div>

                                <div id="phone-generator-section" class="hidden">
                    <p id="message-generate-phone" class="text-gray-600 mb-6">කරුණාකර දුරකථන අංකයක් ඇතුළත් කරන්න.</p>
                    <div class="flex items-center space-x-2 mb-4">
                        <select id="country-code" class="p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:border-transparent transition-all duration-300">
                                                    </select>
                        <input type="tel" id="phone-input" placeholder="දුරකථන අංකය (10 ඉලක්කම්)" class="flex-1 p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:border-transparent transition-all duration-300">
                    </div>
                </div>
                
                                <button id="generate-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-4 rounded-lg transition-colors transform hover:scale-105 duration-300 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 shadow-md">QR කේතය සාදන්න</button>

                                <div id="result-container" class="mt-8 scale-in">
                    <div id="qrcode" class="flex justify-center p-4 bg-gray-100 rounded-xl"></div>
                                        <div id="action-buttons" class="flex justify-center space-x-4 mt-4 hidden">
                                                <button id="download-button" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 px-4 rounded-lg transition-colors transform hover:scale-105 duration-300 focus:outline-none focus:ring-4 focus:ring-emerald-500 focus:ring-opacity-50 shadow-md">බාගත කරන්න</button>
                                                <button id="share-button" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white font-bold py-4 px-4 rounded-lg transition-colors transform hover:scale-105 duration-300 focus:outline-none focus:ring-4 focus:ring-sky-500 focus:ring-opacity-50 shadow-md">බෙදාගන්න</button>
                    </div>
                </div>
            </div>

                        <div id="scanner-section" class="hidden">
                <h1 class="text-4xl font-extrabold text-gray-800 mb-6" id="scanner-title">QR කේත ස්කෑනරය</h1>
                <p id="message-scan" class="text-gray-600 mb-6">ස්කෑන් කිරීම ආරම්භ කිරීමට කැමරාව භාවිතා කරන්න හෝ රූපයක් උඩුගත කරන්න.</p>
                <div class="relative w-full h-auto max-w-sm mx-auto mb-4">
                    <video id="video-feed" autoplay playsinline class="rounded-lg w-full h-auto"></video>
                    <canvas id="qr-canvas" class="hidden"></canvas>
                </div>
                <div class="flex justify-center space-x-4 mb-4">
                    <button id="scan-button" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-4 rounded-lg transition-colors transform hover:scale-105 duration-300 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 shadow-md">කැමරාවෙන් ස්කෑන් කරන්න</button>
                    <label class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 px-4 rounded-lg cursor-pointer transition-colors transform hover:scale-105 duration-300 focus:outline-none focus:ring-4 focus:ring-emerald-500 focus:ring-opacity-50 shadow-md">
                        රූපයක් උඩුගත කරන්න
                        <input type="file" id="upload-input" accept="image/*" class="hidden">
                    </label>
                </div>
                <div id="scan-result-container" class="mt-4">
                    <p id="scan-result" class="text-center text-lg font-bold text-gray-700"></p>
                    <button id="open-link-button" class="mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 hidden">වෙබ් ලිපිනය විවෘත කරන්න</button>
                </div>
            </div>
            
            <button id="logout-button" class="mt-6 text-sm text-gray-600 hover:underline">ආපසු යන්න</button>
        </div>
    </div>

        <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.min.js"></script>

    <script>
        // Language package
        const translations = {
            si: {
                authTitle: 'QR කේත ඇප් එක',
                authMessage: 'කරුණාකර ඔබගේ නම ඇතුළත් කරන්න.',
                loginNamePlaceholder: 'ඔබගේ නම',
                loginButton: 'ඉදිරියට යන්න',
                modeGenerator: 'සාදන්නා',
                modeScanner: 'ස්කෑනරය',
                qrTitle: 'QR කේත සාදන්න',
                genModeUrl: 'වෙබ් ලිපිනය',
                genModePhone: 'දුරකථන අංකය',
                qrMessageUrl: 'කරුණාකර URL එකක් ඇතුළත් කරන්න.',
                qrMessagePhone: 'කරුණාකර දුරකථන අංකයක් ඇතුළත් කරන්න.',
                urlInputPlaceholder: 'වෙබ් ලිපිනයක් මෙහි ඇතුළත් කරන්න',
                phoneInputPlaceholder: 'දුරකථන අංකය (10 ඉලක්කම්)',
                selectCountryCode: 'රටේ කේතය තෝරන්න',
                generateButton: 'QR කේතය සාදන්න',
                downloadButton: 'බාගත කරන්න',
                shareButton: 'බෙදාගන්න',
                logoutButton: 'ආපසු යන්න',
                scannerTitle: 'QR කේත ස්කෑනරය',
                scannerMessage: 'ස්කෑන් කිරීම ආරම්භ කිරීමට කැමරාව භාවිතා කරන්න හෝ රූපයක් උඩුගත කරන්න.',
                scanButton: 'කැමරාවෙන් ස්කෑන් කරන්න',
                uploadButton: 'රූපයක් උඩුගත කරන්න',
                successLogin: (name) => `ආයුබෝවන් ${name}!`,
                errorFillFields: 'කරුණාකර ඔබේ නම ඇතුළත් කරන්න!',
                errorUrlInput: 'කරුණාකර වලංගු වෙබ් ලිපිනයක් ඇතුළත් කරන්න!',
                errorPhoneInput: 'කරුණාකර වලංගු 10-ඉලක්කම් දුරකථන අංකයක් ඇතුළත් කරන්න (0 න් ආරම්භ වන).',
                scanResult: (result) => `ස්කෑන් කරන ලද දත්ත: ${result}`,
                scanError: 'QR කේතයක් හඳුනා ගැනීමට නොහැකි විය.',
                cameraError: 'කැමරාවට ප්‍රවේශ වීමේ දෝෂයක්: ',
                shareFallback: 'ඔබගේ බ්‍රව්සරය බෙදාගැනීමේ විශේෂාංගයට සහය නොදක්වයි. කරුණාකර QR කේතය බාගත කර අතින් බෙදාගන්න.',
                openLinkButton: 'වෙබ් ලිපිනය විවෘත කරන්න',
                openDialerButton: 'දුරකථන අංකය අමතන්න'
            },
            en: {
                authTitle: 'QR Code App',
                authMessage: 'Please enter your name.',
                loginNamePlaceholder: 'Your Name',
                loginButton: 'Continue',
                modeGenerator: 'Generator',
                modeScanner: 'Scanner',
                qrTitle: 'QR Code Maker',
                genModeUrl: 'Web URL',
                genModePhone: 'Phone Number',
                qrMessageUrl: 'Please enter a URL.',
                qrMessagePhone: 'Please enter a phone number.',
                urlInputPlaceholder: 'Enter a URL here',
                phoneInputPlaceholder: 'Phone Number (10 digits)',
                selectCountryCode: 'Select Country Code',
                generateButton: 'Generate QR Code',
                downloadButton: 'Download',
                shareButton: 'Share',
                logoutButton: 'Go Back',
                scannerTitle: 'QR Code Scanner',
                scannerMessage: 'Use the camera to scan or upload an image to get started.',
                scanButton: 'Scan with Camera',
                uploadButton: 'Upload an Image',
                successLogin: (name) => `Hello, ${name}!`,
                errorFillFields: 'Please enter your name!',
                errorUrlInput: 'Please enter a valid website URL!',
                errorPhoneInput: 'Please enter a valid 10-digit phone number (starting with 0).',
                scanResult: (result) => `Scanned Data: ${result}`,
                scanError: 'Could not detect a QR code.',
                cameraError: 'Error accessing the camera: ',
                shareFallback: 'Your browser does not support sharing. Please download the QR code and share it manually.',
                openLinkButton: 'Open Link',
                openDialerButton: 'Call Phone Number'
            }
        };

        const countryCodes = [
            { code: '+94', name: 'Sri Lanka' },
            { code: '+91', name: 'India' },
            { code: '+1', name: 'USA' },
            { code: '+44', name: 'UK' },
            { code: '+61', name: 'Australia' }
        ];

        let currentLang = 'si';
        let currentGeneratorMode = 'url';
        let currentUser = null; // Stores user login status
        let videoStream = null; // To store the camera stream
        let lastScannedData = '';

        // Get HTML elements into JavaScript variables
        const langToggle = document.getElementById('lang-toggle');
        const authContainer = document.getElementById('auth-container');
        const qrCodeContainer = document.getElementById('qr-code-container');
        const authTitle = document.getElementById('auth-title');
        const authMessage = document.getElementById('auth-message');
        const loginForm = document.getElementById('login-form');
        const userNameInput = document.getElementById('user-name');
        const loginButton = document.getElementById('login-button');
        
        const modeGeneratorButton = document.getElementById('mode-generator');
        const modeScannerButton = document.getElementById('mode-scanner');
        const generatorSection = document.getElementById('generator-section');
        const scannerSection = document.getElementById('scanner-section');

        const qrTitle = document.getElementById('qr-title');
        const urlGeneratorSection = document.getElementById('url-generator-section');
        const phoneGeneratorSection = document.getElementById('phone-generator-section');
        const genModeUrlButton = document.getElementById('gen-mode-url');
        const genModePhoneButton = document.getElementById('gen-mode-phone');
        
        const messageGenerateUrl = document.getElementById('message-generate-url');
        const messageGeneratePhone = document.getElementById('message-generate-phone');
        const urlInput = document.getElementById('url-input');
        const phoneInput = document.getElementById('phone-input');
        const countryCodeSelect = document.getElementById('country-code');
        const generateButton = document.getElementById('generate-button');
        const qrcodeContainer = document.getElementById('qrcode');
        const actionButtons = document.getElementById('action-buttons');
        const downloadButton = document.getElementById('download-button');
        const shareButton = document.getElementById('share-button');
        const logoutButton = document.getElementById('logout-button');
        const userInfoDisplay = document.getElementById('user-info');

        const scannerTitle = document.getElementById('scanner-title');
        const messageScan = document.getElementById('message-scan');
        const videoFeed = document.getElementById('video-feed');
        const qrCanvas = document.getElementById('qr-canvas');
        const scanButton = document.getElementById('scan-button');
        const uploadInput = document.getElementById('upload-input');
        const scanResult = document.getElementById('scan-result');
        const openLinkButton = document.getElementById('open-link-button');
        const canvasCtx = qrCanvas.getContext('2d');
        
        // Function to update all page text based on the current language
        function updateLanguage() {
            const t = translations[currentLang];
            authTitle.textContent = t.authTitle;
            authMessage.textContent = t.authMessage;
            userNameInput.placeholder = t.loginNamePlaceholder;
            loginButton.textContent = t.loginButton;
            modeGeneratorButton.textContent = t.modeGenerator;
            modeScannerButton.textContent = t.modeScanner;
            qrTitle.textContent = t.qrTitle;
            genModeUrlButton.textContent = t.genModeUrl;
            genModePhoneButton.textContent = t.genModePhone;
            messageGenerateUrl.textContent = t.qrMessageUrl;
            messageGeneratePhone.textContent = t.qrMessagePhone;
            urlInput.placeholder = t.urlInputPlaceholder;
            phoneInput.placeholder = t.phoneInputPlaceholder;
            generateButton.textContent = t.generateButton;
            downloadButton.textContent = t.downloadButton;
            shareButton.textContent = t.shareButton;
            logoutButton.textContent = t.logoutButton;
            scannerTitle.textContent = t.scannerTitle;
            messageScan.textContent = t.scannerMessage;
            scanButton.textContent = t.scanButton;
            openLinkButton.textContent = t.openLinkButton;
            langToggle.textContent = currentLang === 'si' ? 'English' : 'සිංහල';
        }
        
        // Function to populate country codes
        function populateCountryCodes() {
            countryCodes.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.textContent = `${country.name} (${country.code})`;
                countryCodeSelect.appendChild(option);
            });
            countryCodeSelect.value = '+94'; // Set Sri Lanka as default
        }

        // Function to toggle between the login and QR code sections
        function toggleUI(loggedIn = false, name = null) {
            if (loggedIn) {
                authContainer.classList.add('hidden');
                qrCodeContainer.classList.remove('hidden');
                qrCodeContainer.classList.add('fade-in');
                userInfoDisplay.textContent = translations[currentLang].successLogin(name);
            } else {
                authContainer.classList.remove('hidden');
                qrCodeContainer.classList.add('hidden');
                userNameInput.value = '';
            }
            updateLanguage();
        }

        // Language toggle button event listener
        langToggle.addEventListener('click', () => {
            currentLang = currentLang === 'si' ? 'en' : 'si';
            updateLanguage();
        });
        
        // Login process (using only name)
        loginButton.addEventListener('click', () => {
            const name = userNameInput.value.trim();
            if (!name) {
                authMessage.textContent = translations[currentLang].errorFillFields;
                return;
            }
            currentUser = { name: name };
            toggleUI(true, currentUser.name);
        });

        // Go back/logout function
        logoutButton.addEventListener('click', () => {
            currentUser = null;
            toggleUI(false);
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
        });

        // ### Mode selection (Generator vs. Scanner) ###
        modeGeneratorButton.addEventListener('click', () => {
            generatorSection.classList.remove('hidden');
            scannerSection.classList.add('hidden');
            modeGeneratorButton.classList.add('bg-indigo-600', 'text-white');
            modeGeneratorButton.classList.remove('bg-gray-200', 'text-gray-700');
            modeScannerButton.classList.add('bg-gray-200', 'text-gray-700');
            modeScannerButton.classList.remove('bg-indigo-600', 'text-white');
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
        });

        modeScannerButton.addEventListener('click', () => {
            scannerSection.classList.remove('hidden');
            generatorSection.classList.add('hidden');
            modeScannerButton.classList.add('bg-indigo-600', 'text-white');
            modeScannerButton.classList.remove('bg-gray-200', 'text-gray-700');
            modeGeneratorButton.classList.add('bg-gray-200', 'text-gray-700');
            modeGeneratorButton.classList.remove('bg-indigo-600', 'text-white');
            // Stop any previous stream
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            scanResult.textContent = '';
            openLinkButton.classList.add('hidden');
        });

        // ### Generator mode selection ###
        genModeUrlButton.addEventListener('click', () => {
            currentGeneratorMode = 'url';
            urlGeneratorSection.classList.remove('hidden');
            phoneGeneratorSection.classList.add('hidden');
            genModeUrlButton.classList.add('bg-indigo-600', 'text-white');
            genModeUrlButton.classList.remove('bg-gray-200', 'text-gray-700');
            genModePhoneButton.classList.add('bg-gray-200', 'text-gray-700');
            genModePhoneButton.classList.remove('bg-indigo-600', 'text-white');
            qrcodeContainer.innerHTML = '';
            actionButtons.classList.add('hidden');
        });

        genModePhoneButton.addEventListener('click', () => {
            currentGeneratorMode = 'phone';
            urlGeneratorSection.classList.add('hidden');
            phoneGeneratorSection.classList.remove('hidden');
            genModePhoneButton.classList.add('bg-indigo-600', 'text-white');
            genModePhoneButton.classList.remove('bg-gray-200', 'text-gray-700');
            genModeUrlButton.classList.add('bg-gray-200', 'text-gray-700');
            genModeUrlButton.classList.remove('bg-indigo-600', 'text-white');
            qrcodeContainer.innerHTML = '';
            actionButtons.classList.add('hidden');
        });

        // ### QR Code Generator Process ###
        generateButton.addEventListener('click', () => {
            let qrText = '';
            if (currentGeneratorMode === 'url') {
                let url = urlInput.value.trim();
                if (url) {
                    const urlPattern = /^(http|https):\/\/[^ "]+$/;
                    if (!urlPattern.test(url)) {
                        if (!url.startsWith('http://') && !url.startsWith('https://')) {
                            url = 'https://' + url;
                        }
                        if (!urlPattern.test(url)) {
                            alert(translations[currentLang].errorUrlInput);
                            return;
                        }
                    }
                    qrText = url;
                } else {
                    alert(translations[currentLang].errorFillFields);
                    return;
                }
            } else if (currentGeneratorMode === 'phone') {
                const countryCode = countryCodeSelect.value;
                const phoneNumber = phoneInput.value.trim();
                if (phoneNumber) {
                    // Validate phone number
                    const phonePattern = /^[0-9]{10}$/;
                    if (!phonePattern.test(phoneNumber)) {
                        alert(translations[currentLang].errorPhoneInput);
                        return;
                    }
                    qrText = `tel:${countryCode}${phoneNumber.startsWith('0') ? phoneNumber.substring(1) : phoneNumber}`;
                } else {
                    alert(translations[currentLang].errorFillFields);
                    return;
                }
            }

            if (qrText) {
                qrcodeContainer.innerHTML = '';
                new QRCode(qrcodeContainer, {
                    text: qrText,
                    width: 256,
                    height: 256,
                    colorDark: "#1f2937",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                actionButtons.classList.remove('hidden');
                lastScannedData = qrText;
            }
        });

        // Download QR code as PNG
        downloadButton.addEventListener('click', () => {
            const canvas = qrcodeContainer.querySelector('canvas');
            if (canvas) {
                const url = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = url;
                a.download = 'qrcode.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        });

        // Share QR code image
        shareButton.addEventListener('click', async () => {
            const canvas = qrcodeContainer.querySelector('canvas');
            if (!canvas) return;

            try {
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const file = new File([blob], 'qrcode.png', { type: 'image/png' });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'QR Code',
                        text: 'Check out this QR code I generated!'
                    });
                } else {
                    alert(translations[currentLang].shareFallback);
                }
            } catch (error) {
                console.error('Sharing failed:', error);
                alert(`Sharing failed: ${error.message}`);
            }
        });

        // ### QR Code Scanner Process ###

        // Start camera stream
        scanButton.addEventListener('click', async () => {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                videoFeed.srcObject = videoStream;
                videoFeed.play();
                requestAnimationFrame(tick);
                scanResult.textContent = '';
                openLinkButton.classList.add('hidden');
            } catch (error) {
                console.error(translations[currentLang].cameraError, error);
                scanResult.textContent = translations[currentLang].cameraError + error.message;
            }
        });

        // Continuous scanning loop
        function tick() {
            if (videoFeed.readyState === videoFeed.HAVE_ENOUGH_DATA) {
                qrCanvas.height = videoFeed.videoHeight;
                qrCanvas.width = videoFeed.videoWidth;
                canvasCtx.drawImage(videoFeed, 0, 0, qrCanvas.width, qrCanvas.height);
                const imageData = canvasCtx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    if (code.data !== lastScannedData) {
                        lastScannedData = code.data;
                        scanResult.textContent = translations[currentLang].scanResult(code.data);
                        openLinkButton.classList.remove('hidden');
                        if (videoStream) {
                            videoStream.getTracks().forEach(track => track.stop());
                        }
                        openLinkButton.textContent = code.data.startsWith('tel:') ? translations[currentLang].openDialerButton : translations[currentLang].openLinkButton;
                        openLinkButton.onclick = () => {
                            if (code.data.startsWith('http')) {
                                window.open(code.data, '_blank');
                            } else if (code.data.startsWith('tel:')) {
                                window.location.href = code.data;
                            } else {
                                alert('Unsupported data format for opening.');
                            }
                        };
                    }
                }
                requestAnimationFrame(tick);
            }
        }

        // Scan from an uploaded image
        uploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const image = new Image();
                image.onload = () => {
                    qrCanvas.width = image.width;
                    qrCanvas.height = image.height;
                    canvasCtx.drawImage(image, 0, 0, image.width, image.height);
                    const imageData = canvasCtx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    if (code) {
                        scanResult.textContent = translations[currentLang].scanResult(code.data);
                        openLinkButton.classList.remove('hidden');
                        openLinkButton.textContent = code.data.startsWith('tel:') ? translations[currentLang].openDialerButton : translations[currentLang].openLinkButton;
                        openLinkButton.onclick = () => {
                            window.open(code.data.startsWith('http') ? code.data : code.data, '_blank');
                        };
                    } else {
                        scanResult.textContent = translations[currentLang].scanError;
                        openLinkButton.classList.add('hidden');
                    }
                };
                image.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
        
        // Initial function calls on page load
        populateCountryCodes();
        updateLanguage();
    </script>
</body>
</html>
